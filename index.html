<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>מנהל המעבדה Pro v0.2.7</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Assistant', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #F8FAFC;
            overscroll-behavior-y: none; /* Prevents pull-to-refresh on mobile app feel */
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* Animation Utilities */
        .animate-enter { animation: enter 0.3s ease-out forwards; }
        @keyframes enter {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-enter { animation: modalPop 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Hide Number Arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- Helper Component for Icons ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                lucide.createIcons();
            }, [name]); 
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- Main App Component ---
        const App = () => {
            // --- Configuration ---
            const APP_VERSION = '0.2.7';
            const ADMIN_PASSWORD = '6470';
            const STORAGE = {
                ITEMS: 'inventory_items_v27',
                DELETED: 'inventory_deleted_v27',
                LOGS: 'inventory_logs_v27'
            };
            const MAX_IMG_WIDTH = 800;

            // --- State Initialization (Safe Parsing) ---
            const loadState = (key) => {
                try {
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : [];
                } catch (e) { console.error("Storage Error", e); return []; }
            };

            const [items, setItems] = useState(() => loadState(STORAGE.ITEMS));
            const [deletedItems, setDeletedItems] = useState(() => loadState(STORAGE.DELETED));
            const [logs, setLogs] = useState(() => loadState(STORAGE.LOGS));

            // UI State
            const [isAdmin, setIsAdmin] = useState(false);
            const [activeTab, setActiveTab] = useState('catalog');
            const [searchTerm, setSearchTerm] = useState('');
            const [showLogin, setShowLogin] = useState(false);
            const [loginPass, setLoginPass] = useState('');
            
            // Modals
            const [withdrawModal, setWithdrawModal] = useState(null);
            const [editModal, setEditModal] = useState(null);
            const [showCamera, setShowCamera] = useState(false);
            
            // Forms Data
            const [withdrawData, setWithdrawData] = useState({ amount: 1, reason: '' });
            const [newItem, setNewItem] = useState({ 
                name: '', shelf: '', compartment: '', box: '', quantity: 1, minStock: 2, image: null 
            });
            const [errorMsg, setErrorMsg] = useState('');

            // Refs
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const streamRef = useRef(null);
            const fileInputRef = useRef(null);

            // --- Effects ---
            useEffect(() => { localStorage.setItem(STORAGE.ITEMS, JSON.stringify(items)); }, [items]);
            useEffect(() => { localStorage.setItem(STORAGE.DELETED, JSON.stringify(deletedItems)); }, [deletedItems]);
            useEffect(() => { localStorage.setItem(STORAGE.LOGS, JSON.stringify(logs)); }, [logs]);
            
            useEffect(() => { lucide.createIcons(); }); // Re-render icons on updates

            // --- Image Logic ---
            const compressImage = (base64) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = base64;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;
                        if (width > MAX_IMG_WIDTH) {
                            height = (MAX_IMG_WIDTH / width) * height;
                            width = MAX_IMG_WIDTH;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.75));
                    };
                });
            };

            const handleCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment', width: { ideal: 1280 } } 
                    });
                    streamRef.current = stream;
                    setShowCamera(true);
                } catch (e) { alert("שגיאה בפתיחת מצלמה. וודא הרשאות."); }
            };

            useEffect(() => {
                if (showCamera && videoRef.current && streamRef.current) {
                    videoRef.current.srcObject = streamRef.current;
                }
                return () => {
                    if (!showCamera && streamRef.current) {
                        streamRef.current.getTracks().forEach(t => t.stop());
                    }
                };
            }, [showCamera]);

            const capturePhoto = async () => {
                if (!videoRef.current || !canvasRef.current) return;
                const canvas = canvasRef.current;
                canvas.width = videoRef.current.videoWidth;
                canvas.height = videoRef.current.videoHeight;
                canvas.getContext('2d').drawImage(videoRef.current, 0, 0);
                const img = await compressImage(canvas.toDataURL('image/jpeg'));
                
                if (editModal) setEditModal(prev => ({ ...prev, image: img }));
                else setNewItem(prev => ({ ...prev, image: img }));
                
                setShowCamera(false);
            };

            const handleFileSelect = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const img = await compressImage(reader.result);
                    if (editModal) setEditModal(prev => ({ ...prev, image: img }));
                    else setNewItem(prev => ({ ...prev, image: img }));
                };
                reader.readAsDataURL(file);
            };

            // --- Validators ---
            const validateLoc = (val, type) => {
                if (type === 'shelf') return val.toUpperCase().replace(/[^A-Z]/g, '').slice(0, 1);
                if (type === 'comp') return val.toLowerCase().replace(/[^a-z]/g, '').slice(0, 1);
                if (type === 'box') return val.replace(/\D/g, '').slice(0, 3);
                return val;
            };

            const checkConflict = (s, c, b, id = null) => items.find(i => i.id !== id && i.shelf === s && i.compartment === c && i.box === b);

            // --- CRUD Actions ---
            const addLog = (action, item, details) => {
                setLogs(prev => [{
                    id: Date.now(), timestamp: new Date().toLocaleString('he-IL'), action, item, details
                }, ...prev]);
            };

            const addItem = () => {
                setErrorMsg('');
                if (!newItem.name || !newItem.shelf || !newItem.compartment || !newItem.box) return setErrorMsg('חסרים פרטים');
                if (checkConflict(newItem.shelf, newItem.compartment, newItem.box)) return setErrorMsg('מיקום תפוס');
                
                const item = { ...newItem, id: Date.now().toString() };
                setItems(prev => [item, ...prev]);
                addLog('הוספה', item.name, `מיקום ${item.shelf}${item.compartment}${item.box}`);
                setNewItem({ name: '', shelf: '', compartment: '', box: '', quantity: 1, minStock: 2, image: null });
                setActiveTab('admin-list');
            };

            const updateItem = () => {
                if (checkConflict(editModal.shelf, editModal.compartment, editModal.box, editModal.id)) return alert('מיקום תפוס');
                setItems(prev => prev.map(i => i.id === editModal.id ? editModal : i));
                addLog('עדכון', editModal.name, 'עריכת פרטים');
                setEditModal(null);
            };

            const deleteItem = (id, soft = true) => {
                if (soft) {
                    const item = items.find(i => i.id === id);
                    setDeletedItems(prev => [{ ...item, deletedAt: new Date().toLocaleString('he-IL') }, ...prev]);
                    setItems(prev => prev.filter(i => i.id !== id));
                    addLog('מחיקה', item.name, 'הועבר לסל מחזור');
                } else {
                    if (confirm('למחוק לצמיתות?')) setDeletedItems(prev => prev.filter(i => i.id !== id));
                }
            };

            const restoreItem = (id) => {
                const item = deletedItems.find(i => i.id === id);
                if (checkConflict(item.shelf, item.compartment, item.box)) return alert('המיקום המקורי תפוס, לא ניתן לשחזר');
                
                const { deletedAt, ...restored } = item;
                setItems(prev => [restored, ...prev]);
                setDeletedItems(prev => prev.filter(i => i.id !== id));
                addLog('שחזור', item.name, 'שוחזר מהסל');
            };

            const withdrawItem = () => {
                if (!withdrawData.reason) return alert('חובה לציין סיבה');
                setItems(prev => prev.map(i => i.id === withdrawModal.id ? { ...i, quantity: i.quantity - withdrawData.amount } : i));
                addLog('משיכה', withdrawModal.name, `${withdrawData.amount} יח'. סיבה: ${withdrawData.reason}`);
                setWithdrawModal(null);
                setWithdrawData({ amount: 1, reason: '' });
            };

            // --- Render Helpers ---
            const sortedItems = useMemo(() => {
                return items.filter(i => 
                    i.name.includes(searchTerm) || `${i.shelf}${i.compartment}${i.box}`.includes(searchTerm)
                ).sort((a,b) => a.shelf.localeCompare(b.shelf) || a.compartment.localeCompare(b.compartment) || a.box - b.box);
            }, [items, searchTerm]);

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24 relative">
                    
                    {/* Header */}
                    <header className="bg-white/90 backdrop-blur-md p-4 sticky top-0 z-30 shadow-sm flex justify-between items-center rounded-b-3xl">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 text-white p-2.5 rounded-2xl shadow-lg shadow-indigo-200">
                                <Icon name="package" />
                            </div>
                            <div>
                                <h1 className="font-black text-lg leading-none text-slate-800">מנהל המעבדה</h1>
                                <span className="text-[10px] font-bold text-slate-400 tracking-wider">PRO v{APP_VERSION}</span>
                            </div>
                        </div>
                        <button onClick={() => isAdmin ? setIsAdmin(false) : setShowLogin(true)} 
                            className={`p-2.5 rounded-xl transition-colors ${isAdmin ? 'bg-red-50 text-red-500' : 'bg-slate-100 text-slate-600'}`}>
                            <Icon name={isAdmin ? "lock" : "settings"} />
                        </button>
                    </header>

                    <div className="p-5">
                        {/* Search */}
                        {activeTab !== 'logs' && activeTab !== 'bin' && (
                            <div className="relative mb-6 group">
                                <input 
                                    type="text" 
                                    placeholder="חיפוש מהיר..." 
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                    className="w-full p-4 pr-12 bg-white rounded-2xl shadow-sm border border-transparent focus:border-indigo-500 outline-none font-bold text-slate-700 transition-all placeholder:font-normal"
                                />
                                <div className="absolute right-4 top-4 text-slate-300 group-focus-within:text-indigo-500 transition-colors">
                                    <Icon name="search" />
                                </div>
                            </div>
                        )}

                        {/* Admin Tabs */}
                        {isAdmin && (
                            <div className="flex bg-slate-200/50 p-1.5 rounded-2xl mb-6 overflow-x-auto no-scrollbar gap-1">
                                {[
                                    {id: 'admin-list', label: 'מלאי', icon: 'clipboard-list'},
                                    {id: 'add', label: 'חדש', icon: 'plus-circle'},
                                    {id: 'bin', label: 'סל', icon: 'trash-2'},
                                    {id: 'logs', label: 'יומן', icon: 'history'}
                                ].map(tab => (
                                    <button 
                                        key={tab.id} 
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`flex-1 flex items-center justify-center gap-1.5 py-2.5 px-2 rounded-xl text-xs font-black whitespace-nowrap transition-all ${activeTab === tab.id ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}
                                    >
                                        <Icon name={tab.icon} size={16} /> {tab.label}
                                    </button>
                                ))}
                            </div>
                        )}

                        {/* --- VIEWS --- */}

                        {/* Catalog / List */}
                        {(activeTab === 'catalog' || activeTab === 'admin-list') && (
                            <div className="space-y-4 animate-enter">
                                {sortedItems.length === 0 ? (
                                    <div className="text-center py-20 text-slate-300">
                                        <div className="mx-auto mb-4 w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center"><Icon name="package-open" size={32}/></div>
                                        <p className="font-bold">אין פריטים להצגה</p>
                                    </div>
                                ) : (
                                    sortedItems.map(item => (
                                        <div key={item.id} className="bg-white p-3 rounded-[1.25rem] flex items-center gap-4 shadow-sm border border-slate-50">
                                            <div className="relative w-20 h-20 bg-slate-50 rounded-2xl shrink-0 overflow-hidden">
                                                {item.image ? <img src={item.image} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-slate-200"><Icon name="image" size={32}/></div>}
                                                {item.quantity <= item.minStock && <div className="absolute top-1 right-1 w-2.5 h-2.5 bg-orange-500 rounded-full border-2 border-white"></div>}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <h3 className="font-black text-slate-800 text-lg truncate">{item.name}</h3>
                                                <div className="flex items-center gap-2 mt-1">
                                                    <span className="bg-slate-100 text-slate-500 text-[10px] font-black px-2 py-0.5 rounded-md tracking-widest">{item.shelf}{item.compartment}{item.box}</span>
                                                    <span className={`text-[10px] font-black px-2 py-0.5 rounded-md ${item.quantity <= 0 ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-600'}`}>{item.quantity} יח'</span>
                                                </div>
                                            </div>
                                            <div>
                                                {isAdmin ? (
                                                    <div className="flex flex-col gap-2">
                                                        <button onClick={() => setEditModal(item)} className="p-2 bg-slate-50 text-slate-500 rounded-lg hover:bg-indigo-50 hover:text-indigo-600"><Icon name="edit-2" size={16}/></button>
                                                        <button onClick={() => deleteItem(item.id)} className="p-2 bg-red-50 text-red-500 rounded-lg"><Icon name="trash" size={16}/></button>
                                                    </div>
                                                ) : (
                                                    <button onClick={() => setWithdrawModal(item)} disabled={item.quantity <= 0} className={`p-4 rounded-2xl shadow-lg active:scale-95 transition-all ${item.quantity <= 0 ? 'bg-slate-100 text-slate-300 shadow-none' : 'bg-indigo-600 text-white shadow-indigo-200'}`}>
                                                        <Icon name="arrow-down-right" />
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {/* Add Item Form */}
                        {activeTab === 'add' && isAdmin && (
                            <div className="bg-white p-6 rounded-[2rem] shadow-lg animate-enter">
                                <h2 className="text-xl font-black mb-6 text-slate-800">הוספת פריט</h2>
                                <div className="space-y-5">
                                    <div className="flex gap-4 h-32">
                                        <button onClick={handleCamera} className="flex-1 bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center text-slate-400 hover:text-indigo-500 hover:border-indigo-200 transition-colors">
                                            <Icon name="camera" size={24} />
                                            <span className="text-[10px] font-black mt-2">צילום</span>
                                        </button>
                                        <div className="flex-1 relative bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl overflow-hidden flex items-center justify-center">
                                            {newItem.image ? <img src={newItem.image} className="w-full h-full object-cover"/> : <div className="text-slate-300 flex flex-col items-center"><Icon name="image" size={24}/><span className="text-[10px] font-bold mt-2">גלריה</span></div>}
                                            <input type="file" ref={fileInputRef} onChange={handleFileSelect} accept="image/*" className="absolute inset-0 opacity-0" />
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 mr-2">שם הפריט</label>
                                        <input type="text" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} className="w-full p-4 bg-slate-50 rounded-xl font-bold border-2 border-transparent focus:border-indigo-500 outline-none" placeholder="לדוגמה: כבל רשת" />
                                    </div>

                                    <div className="grid grid-cols-3 gap-3">
                                        {['shelf', 'compartment', 'box'].map((field, i) => (
                                            <div key={field}>
                                                <label className="text-[10px] font-black text-slate-400 block text-center mb-1">{['מדף','תא','קופסה'][i]}</label>
                                                <input 
                                                    type="text" 
                                                    value={newItem[field]} 
                                                    onChange={e => setNewItem({...newItem, [field]: validateLoc(e.target.value, field === 'shelf' ? 'shelf' : field === 'compartment' ? 'comp' : 'box')})}
                                                    className="w-full p-3 bg-slate-50 rounded-xl font-black text-center text-lg text-indigo-600 outline-none focus:ring-2 ring-indigo-100"
                                                    placeholder={['A','a','1'][i]}
                                                />
                                            </div>
                                        ))}
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-[10px] font-bold text-slate-400 mr-2">כמות</label><input type="number" value={newItem.quantity} onChange={e => setNewItem({...newItem, quantity: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl font-black text-center" /></div>
                                        <div><label className="text-[10px] font-bold text-slate-400 mr-2">מינימום</label><input type="number" value={newItem.minStock} onChange={e => setNewItem({...newItem, minStock: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl font-black text-center text-orange-500" /></div>
                                    </div>

                                    {errorMsg && <div className="bg-red-50 text-red-500 text-xs font-black p-3 rounded-xl text-center">{errorMsg}</div>}
                                    
                                    <button onClick={addItem} className="w-full py-4 bg-indigo-600 text-white rounded-xl font-black shadow-lg shadow-indigo-200 mt-2">שמור במלאי</button>
                                </div>
                            </div>
                        )}

                        {/* Logs View */}
                        {activeTab === 'logs' && isAdmin && (
                            <div className="space-y-4 animate-enter">
                                <div className="flex justify-between items-center">
                                    <h2 className="font-black text-slate-800">היסטוריית פעולות</h2>
                                    <button onClick={() => setLogs([])} className="text-xs text-red-500 font-bold bg-red-50 px-3 py-1.5 rounded-lg">נקה הכל</button>
                                </div>
                                <div className="space-y-2">
                                    {logs.map(log => (
                                        <div key={log.id} className="bg-white p-4 rounded-xl border-r-4 border-indigo-500 shadow-sm">
                                            <div className="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-1">
                                                <span>{log.action}</span>
                                                <span>{log.timestamp}</span>
                                            </div>
                                            <div className="font-bold text-slate-800">{log.item}</div>
                                            <div className="text-xs text-slate-500 mt-1">{log.details}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Recycle Bin */}
                        {activeTab === 'bin' && isAdmin && (
                            <div className="space-y-4 animate-enter">
                                <h2 className="font-black text-slate-800">פריטים שנמחקו</h2>
                                {deletedItems.length === 0 ? <p className="text-center text-slate-400 py-10 font-bold">הסל ריק</p> : 
                                    deletedItems.map(item => (
                                        <div key={item.id} className="bg-white p-3 rounded-xl flex items-center gap-3 opacity-75">
                                            <div className="w-12 h-12 bg-slate-100 rounded-lg overflow-hidden grayscale shrink-0">{item.image && <img src={item.image} className="w-full h-full object-cover"/>}</div>
                                            <div className="flex-1 min-w-0">
                                                <div className="font-bold text-slate-700 truncate">{item.name}</div>
                                                <div className="text-[10px] text-slate-400">{item.deletedAt}</div>
                                            </div>
                                            <button onClick={() => restoreItem(item.id)} className="p-2 bg-green-50 text-green-600 rounded-lg"><Icon name="rotate-ccw" size={16}/></button>
                                            <button onClick={() => deleteItem(item.id, false)} className="p-2 bg-red-50 text-red-600 rounded-lg"><Icon name="x" size={16}/></button>
                                        </div>
                                    ))
                                }
                            </div>
                        )}
                    </div>

                    {/* --- Modals Overlay --- */}
                    
                    {/* Login Modal */}
                    {showLogin && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-6" onClick={() => setShowLogin(false)}>
                            <div className="bg-white p-8 rounded-[2rem] w-full max-w-xs text-center modal-enter shadow-2xl" onClick={e => e.stopPropagation()}>
                                <div className="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-6"><Icon name="lock" className="text-slate-400"/></div>
                                <h2 className="text-xl font-black mb-6">כניסת מנהל</h2>
                                <input type="password" value={loginPass} onChange={e => setLoginPass(e.target.value)} className="w-full p-4 bg-slate-50 rounded-xl text-center font-black text-2xl tracking-widest mb-4 outline-none focus:ring-2 ring-indigo-500" placeholder="••••" autoFocus />
                                <button onClick={() => { if(loginPass === ADMIN_PASSWORD) { setIsAdmin(true); setShowLogin(false); setLoginPass(''); } }} className="w-full py-4 bg-slate-900 text-white rounded-xl font-black">כניסה</button>
                            </div>
                        </div>
                    )}

                    {/* Withdraw Modal */}
                    {withdrawModal && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4" onClick={() => setWithdrawModal(null)}>
                            <div className="bg-white p-6 rounded-[2rem] w-full max-w-md modal-enter shadow-2xl" onClick={e => e.stopPropagation()}>
                                <div className="flex gap-4 items-center mb-6">
                                    <div className="w-16 h-16 bg-slate-100 rounded-xl overflow-hidden shrink-0">{withdrawModal.image && <img src={withdrawModal.image} className="w-full h-full object-cover"/>}</div>
                                    <div>
                                        <h2 className="font-black text-xl text-slate-800">משיכת פריט</h2>
                                        <p className="text-indigo-600 font-bold">{withdrawModal.name}</p>
                                    </div>
                                </div>
                                <div className="bg-slate-50 p-4 rounded-2xl flex items-center justify-between mb-4">
                                    <button onClick={() => setWithdrawData(p => ({...p, amount: Math.max(1, p.amount-1)}))} className="w-10 h-10 bg-white rounded-xl shadow-sm text-xl font-black text-red-500">-</button>
                                    <span className="text-3xl font-black text-slate-800">{withdrawData.amount}</span>
                                    <button onClick={() => setWithdrawData(p => ({...p, amount: Math.min(withdrawModal.quantity, p.amount+1)}))} className="w-10 h-10 bg-white rounded-xl shadow-sm text-xl font-black text-green-500">+</button>
                                </div>
                                <textarea placeholder="סיבת המשיכה (חובה)" value={withdrawData.reason} onChange={e => setWithdrawData(p => ({...p, reason: e.target.value}))} className="w-full p-4 bg-slate-50 rounded-xl font-bold mb-4 h-24 resize-none outline-none focus:ring-2 ring-indigo-100"></textarea>
                                <button onClick={withdrawItem} className="w-full py-4 bg-indigo-600 text-white rounded-xl font-black shadow-lg shadow-indigo-200">אשר משיכה</button>
                            </div>
                        </div>
                    )}

                    {/* Edit Modal */}
                    {editModal && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setEditModal(null)}>
                            <div className="bg-white p-6 rounded-[2rem] w-full max-w-md modal-enter shadow-2xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                <h2 className="text-xl font-black mb-6">עריכת פריט</h2>
                                <div className="space-y-4">
                                    <div className="h-32 bg-slate-50 rounded-2xl overflow-hidden relative group cursor-pointer" onClick={handleCamera}>
                                        {editModal.image ? <img src={editModal.image} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-slate-300"><Icon name="camera"/></div>}
                                        <div className="absolute inset-0 bg-black/20 hidden group-hover:flex items-center justify-center text-white font-bold">החלף תמונה</div>
                                    </div>
                                    <input type="text" value={editModal.name} onChange={e => setEditModal({...editModal, name: e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl font-bold border border-transparent focus:border-indigo-500" />
                                    <div className="grid grid-cols-3 gap-2">
                                        <input type="text" value={editModal.shelf} onChange={e => setEditModal({...editModal, shelf: validateLoc(e.target.value, 'shelf')})} className="p-3 bg-slate-50 rounded-xl font-black text-center text-indigo-600" />
                                        <input type="text" value={editModal.compartment} onChange={e => setEditModal({...editModal, compartment: validateLoc(e.target.value, 'comp')})} className="p-3 bg-slate-50 rounded-xl font-black text-center text-indigo-600" />
                                        <input type="text" value={editModal.box} onChange={e => setEditModal({...editModal, box: validateLoc(e.target.value, 'box')})} className="p-3 bg-slate-50 rounded-xl font-black text-center text-indigo-600" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input type="number" value={editModal.quantity} onChange={e => setEditModal({...editModal, quantity: e.target.value})} className="p-3 bg-slate-50 rounded-xl font-black text-center" />
                                        <input type="number" value={editModal.minStock} onChange={e => setEditModal({...editModal, minStock: e.target.value})} className="p-3 bg-slate-50 rounded-xl font-black text-center text-orange-500" />
                                    </div>
                                    <button onClick={updateItem} className="w-full py-4 bg-indigo-600 text-white rounded-xl font-black shadow-lg">עדכן</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Camera Overlay */}
                    {showCamera && (
                        <div className="fixed inset-0 bg-black z-[100] flex flex-col items-center justify-center">
                            <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover" />
                            <canvas ref={canvasRef} className="hidden" />
                            <div className="absolute bottom-10 flex gap-8 items-center">
                                <button onClick={stopCamera} className="bg-white/20 p-4 rounded-full text-white backdrop-blur-md"><Icon name="x" size={32}/></button>
                                <button onClick={capturePhoto} className="w-20 h-20 bg-white rounded-full border-4 border-white/50 flex items-center justify-center shadow-2xl"><div className="w-16 h-16 bg-red-500 rounded-full"></div></button>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
